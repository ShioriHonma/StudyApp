<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>やらかしチェッカー</title>
  <style>
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      max-width: 640px;
      margin: 2em auto;
      padding: 2em;
      background-color: #f9f9f9;
      color: #333;
    }
    h1, h3 {
      text-align: center;
      font-weight: bold;
      margin-bottom: 1em;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 0.6em;
      margin: 0.6em 0;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      padding: 0.6em 1.2em;
      font-size: 1em;
      border: none;
      border-radius: 6px;
      background-color: #2c7be5;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
      margin: 0.5em 0.5em 0 0;
    }
    button:hover {
      background-color: #1a5fc3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      background-color: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.6em;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    .button-group {
      margin-top: 1.5em;
    }
    .filename-wrapper {
      margin-top: 1.5em;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .filename-wrapper input {
      flex: 1;
    }
  </style>
</head>
<body>
  <div id="checkerView">
    <h1>またやらかしたチェッカー</h1>
    <p>1〜80の問題番号をカンマ区切りで入力（最大4欄）:</p>
    <input type="text" id="input1" placeholder="例: 1,2,3">
    <input type="text" id="input2" placeholder="例: 4,5,6">
    <input type="text" id="input3" placeholder="例: 7,8,9">
    <input type="text" id="input4" placeholder="例: 10,11,12">

    <div class="button-group">
      <button onclick="analyzeMistakes()">出力する</button>
      <button onclick="showEditorView()">詳しく振り返る</button>
    </div>

    <h3>3回以上間違えた問題:</h3>
    <textarea id="resultArea" rows="2" readonly></textarea>
  </div>

  <div id="editorView" style="display: none;">
    <h3>弱点データ編集:</h3>
    <table id="editTable">
      <thead>
        <tr><th>問題番号</th><th>分野</th><th>誤答理由・克服方法</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="filename-wrapper">
      <label for="filenameField">保存ファイル名：</label>
      <input type="text" id="filenameField" placeholder="例: mistakes.csv">
    </div>

    <div class="button-group">
      <button onclick="downloadCSV()">CSV保存</button>
      <button onclick="showCheckerView()">入力画面に戻る</button>
    </div>
  </div>

  <script>
    const placeholderDefault = "例: 1,2,3";
    ["input1", "input2", "input3", "input4"].forEach(id => {
      const input = document.getElementById(id);
      input.addEventListener("focus", () => {
        if (input.value === placeholderDefault) {
          input.value = "";
          input.style.color = "black";
        }
      });
      input.addEventListener("blur", () => {
        if (input.value.trim() === "") {
          input.value = placeholderDefault;
          input.style.color = "gray";
        }
      });
      input.value = placeholderDefault;
      input.style.color = "gray";
    });

    function analyzeMistakes() {
      const inputs = ["input1", "input2", "input3", "input4"]
        .map(id => document.getElementById(id).value)
        .filter(s => !s.startsWith("例:"))
        .join(",");
      const counts = Array(81).fill(0);

      inputs.split(',').forEach(s => {
        const n = parseInt(s.trim(), 10);
        if (!isNaN(n) && n >= 1 && n <= 80) counts[n]++;
      });

      const mistakes = [];
      for (let i = 1; i <= 80; i++) {
        if (counts[i] >= 3) mistakes.push(i);
      }

      document.getElementById("resultArea").value = mistakes.join(", ");

      const tbody = document.querySelector("#editTable tbody");
      tbody.innerHTML = "";
      mistakes.forEach(num => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${num}</td>
          <td><input type="text" style="width: 100%; border: none;"/></td>
          <td><input type="text" style="width: 100%; border: none;"/></td>`;
        tbody.appendChild(row);
      });
    }

    function escapeCsv(str) {
      if (!str) return "";
      const needsQuote = /[",\n\r]/.test(str);
      const escaped = str.replace(/"/g, '""');
      return needsQuote ? `"${escaped}"` : escaped;
    }

    function downloadCSV() {
      let filename = document.getElementById("filenameField").value.trim();
      if (!filename) filename = "mistakes.csv";
      if (!filename.endsWith(".csv")) filename += ".csv";

      const rows = ["\uFEFF問題番号,分野,誤答理由・克服方法\r\n"];
      document.querySelectorAll("#editTable tbody tr").forEach(tr => {
        const tds = tr.querySelectorAll("td, td input");
        const num = tds[0].textContent;
        const cat = escapeCsv(tds[1].querySelector("input").value);
        const note = escapeCsv(tds[2].querySelector("input").value);
        rows.push(`${num},${cat},${note}\r\n`);
      });

      const blob = new Blob(rows, { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    function showEditorView() {
      document.getElementById("checkerView").style.display = "none";
      document.getElementById("editorView").style.display = "block";
    }

    function showCheckerView() {
      document.getElementById("editorView").style.display = "none";
      document.getElementById("checkerView").style.display = "block";
    }
  </script>
</body>
</html>
